name: Auto-Fix Pre-Commit Issues on Main

on:
  push:
    branches:
      - main
      - test/*

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-fix-main:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11.2'

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          poetry install --no-interaction

      - name: Run pre-commit checks
        id: precommit
        continue-on-error: true
        run: |
          poetry run pre-commit run --all-files

      - name: Check if fixes are needed
        id: check_fixes
        if: steps.precommit.outcome == 'failure'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "fixes_needed=true" >> $GITHUB_OUTPUT
            echo "Pre-commit made auto-fixes"
          else
            echo "fixes_needed=false" >> $GITHUB_OUTPUT
            echo "Pre-commit failed but no auto-fixes available"
          fi

      - name: Create fix branch and commit
        if: steps.check_fixes.outputs.fixes_needed == 'true'
        id: create_branch
        run: |
          # Create unique branch name
          BRANCH_NAME="fix/pre-commit-main-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create and switch to new branch
          git checkout -b $BRANCH_NAME
          
          # Commit changes
          git add .
          git commit -m "ü§ñ Auto-fix: Apply pre-commit fixes to main

          This commit automatically applies formatting and linting fixes:
          - Black code formatting
          - isort import sorting
          - ruff linting fixes
          - djLint template formatting
          
          Generated by auto-fix-main-precommit workflow"
          
          # Push branch
          git push origin $BRANCH_NAME

      - name: Create Pull Request
        if: steps.check_fixes.outputs.fixes_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base main \
            --head ${{ steps.create_branch.outputs.branch_name }} \
            --title "ü§ñ Auto-fix: Pre-commit fixes for main branch" \
            --body "## Automated Pre-Commit Fixes

          This PR contains automatic formatting and linting fixes applied to the main branch.

          ### Changes Applied:
          - ‚úÖ Black code formatting
          - ‚úÖ isort import sorting  
          - ‚úÖ ruff linting fixes
          - ‚úÖ djLint template formatting

          ### Commit that triggered this:
          - SHA: ${{ github.sha }}
          - Author: ${{ github.actor }}
          - Message: ${{ github.event.head_commit.message }}

          **‚ö†Ô∏è Please review these changes before merging.**

          ---
          *This PR was automatically created by the auto-fix-main-precommit workflow.*" \
            --label "automated-fix" \
            --label "pre-commit"

      - name: Notify on failure
        if: steps.precommit.outcome == 'failure' && steps.check_fixes.outputs.fixes_needed == 'false'
        run: |
          echo "::error::Pre-commit checks failed on main branch but no auto-fixes could be applied. Manual intervention required."